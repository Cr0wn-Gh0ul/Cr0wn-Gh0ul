<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Troy Salem Blog</title>
    <meta name="description" content="Troy Salem Blog">
    <meta name="author" content="Troy Salem">
    
    <link rel="icon" type="image/png" href="/Cr0wn-Gh0ul/img/ghost-crown.png">
    
    <meta property="og:title" content="BreakerKit: Circuit Breaker Pattern " />
    <meta property="og:description" content="Troy Salem Blog" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://cr0wn-gh0ul.github.io/Cr0wn-Gh0ul/posts/2026-01-06/" />
    <meta property="og:image" content="/Cr0wn-Gh0ul/img/ghost-crown.png" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="BreakerKit: Circuit Breaker Pattern " />
    <meta name="twitter:description" content="Troy Salem Blog" />
    <meta name="twitter:image" content="/Cr0wn-Gh0ul/img/ghost-crown.png" />
    <link rel="stylesheet" href="/Cr0wn-Gh0ul/css/style.css">
    
</head>
<body class="">
    <header class="site-header">
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=JetBrains+Mono:wght@600&display=swap"
        rel="stylesheet">
    <nav class="site-nav">
        <a href="/" class="site-title">Troy Salem Blog</a>
        <ul class="nav-menu">
            
            <li>
                
                
                <a href="/Cr0wn-Gh0ul/" >
                    ./home
                    
                </a>
            </li>
            
            <li>
                
                
                <a href="/Cr0wn-Gh0ul/posts/" >
                    ./posts
                    
                </a>
            </li>
            
            <li>
                
                
                <a href="https://troysalem.com/" >
                    ./website
                    
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor"
                        style="width:1em;height:1em;vertical-align:baseline;position:relative;top:0.13em;margin-left:-0.3em;">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                    </svg>
                    
                </a>
            </li>
            
        </ul>
    </nav>
</header>
    <div id="content-wrapper" class="site-wrapper">
        <main>
            
<article class="single-post">
    <header>
        <h1>BreakerKit: Circuit Breaker Pattern </h1>
        <div class="post-meta">
            January 06, 2026
             · T. Salem
             · 7 min read
        </div>
        
        <div class="tags">
            
            
            <a href="/Cr0wn-Gh0ul/tags/code/">#code</a>
            
            
            <a href="/Cr0wn-Gh0ul/tags/programming/">#programming</a>
            
            </div>  
        
    </header>
    
    <div class="content">
        <h2 id="overview">Overview</h2>
<p>Every app eventually meets <em>The Outside World</em>.
<br></br>
The Outside World is where &quot;fetch&quot; becomes:</p>
<ul>
<li>an API that is slow <em>sometimes</em></li>
<li>a dependency that is down <em>right now</em></li>
<li>a vendor that rate limits you for breathing too loudly</li>
<li>a database that is fine until it is not<br>
<br></br></li>
</ul>
<p>When that happens, most systems fail in the dumbest possible way:
they keep trying, they keep waiting, they pile up threads/promises/jobs, and then they fall over from the weight.</p>
<p>That is what the circuit breaker pattern is trying to prevent.
<br></br></p>
<p>Not &quot;make errors go away&quot;.<br>
OR<br>
Not &quot;magically heal outages&quot;.
<br></br></p>
<p>Do: <strong>stop repeatedly doing the thing that is currently on fire.</strong>
<br></br></p>
<hr>
<h2 id="what-a-circuit-breaker-actually-does">What a circuit breaker actually does</h2>
<div class="mermaid">
  stateDiagram-v2
  direction LR

  [*] --> Closed

  Closed --> Open: failures >= threshold

  Open --> HalfOpen: cooldown elapsed

  HalfOpen --> Closed: successes >= threshold
  HalfOpen --> Open: failure
</div>
<p>A circuit breaker is basically a tiny state machine in front of a risky call.
<br></br>
It has three moods:</p>
<ul>
<li><strong>closed</strong>: calls go through like normal</li>
<li><strong>open</strong>: calls do <em>not</em> go through, you fail fast</li>
<li><strong>half-open</strong>: you cautiously test the water to see if it recovered
<br></br></li>
</ul>
<p>That’s it. That’s the core idea.</p>
<p>The value is not just the fast failure, it is that it prevents <strong>cascading failure</strong>. If a dependency is dying, your app does not need to die with it.
<br></br></p>
<hr>
<h2 id="pitfall-1-treating-retry-and-circuit-breaker-like-the-same-tool">Pitfall 1: treating &quot;retry&quot; and &quot;circuit breaker&quot; like the same tool</h2>
<p>Retry and circuit breaker are cousins, not twins.
<br></br></p>
<ul>
<li><strong>Retry</strong> is betting that the next attempt might succeed.</li>
<li><strong>Circuit breaker</strong> is admitting “this is probably doomed” and refusing to keep paying the cost.
<br></br></li>
</ul>
<p>Retries are great for <em>transient</em> failures (packet loss, short blips).
Retries are also a great way to DDoS your own dependencies if the outage is real.</p>
<p><br></br></p>
<div class="highlight"><div style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Bad: retry everything, forever-ish, no timeout, no jitter
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">async</span> <span style="color:#ff7b72">function</span> callWithRetries() {
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">for</span> (<span style="color:#ff7b72">let</span> attempt <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">1</span>; attempt <span style="color:#ff7b72;font-weight:bold">&lt;=</span> <span style="color:#a5d6ff">12</span>; attempt<span style="color:#ff7b72;font-weight:bold">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">try</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff7b72">return</span> <span style="color:#ff7b72">await</span> callVendor();
</span></span><span style="display:flex;"><span>    } <span style="color:#ff7b72">catch</span> (error) {
</span></span><span style="display:flex;"><span>      <span style="color:#8b949e;font-style:italic">// every instance retries at the same rhythm -&gt; herd behavior
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>      <span style="color:#ff7b72">await</span> sleep(<span style="color:#a5d6ff">250</span> <span style="color:#ff7b72;font-weight:bold">*</span> attempt);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">throw</span> <span style="color:#ff7b72">new</span> Error(<span style="color:#a5d6ff">&#34;vendor failed after retries&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><br></br>
A breaker is the thing that says: &quot;Stop. We will try later.&quot;
<br></br></p>
<hr>
<h2 id="pitfall-2-counting-the-wrong-failures">Pitfall 2: counting the wrong failures</h2>
<p>The breaker needs a signal. If your signal is garbage, your breaker becomes a random number generator.</p>
<p>Common mistakes:</p>
<ul>
<li>Counting <strong>validation errors</strong> as failures. That is not the dependency being down, that is you sending nonsense.</li>
<li>Counting <strong>404s</strong> as failures. If the resource does not exist, your breaker should not &quot;protect&quot; you from reality.</li>
<li>Not separating <strong>rate limits</strong> from <strong>server errors</strong>. Rate limiting is often recoverable, but your strategy might be &quot;slow down&quot; not &quot;trip open&quot;.
<br></br></li>
</ul>
<p>The core question is always:</p>
<blockquote class="custom-blockquote"><p>&quot;Does this failure mean the dependency is unhealthy, or does it mean my request is bad?&quot;</p>
</blockquote>
<p><br></br></p>
<div class="highlight"><div style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">//Bad: every non-200 is treated like &#34;dependency is unhealthy&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">const</span> response <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">await</span> fetch(url);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>response.ok) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">throw</span> <span style="color:#ff7b72">new</span> Error(<span style="color:#a5d6ff">`status </span><span style="color:#a5d6ff">${</span>response.status<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">`</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Better: only &#34;dependency unhealthy&#34; counts
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">if</span> (res.status <span style="color:#ff7b72;font-weight:bold">===</span> <span style="color:#a5d6ff">404</span>) <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">null</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> (res.status <span style="color:#ff7b72;font-weight:bold">===</span> <span style="color:#a5d6ff">429</span>) <span style="color:#ff7b72">throw</span> <span style="color:#ff7b72">new</span> RateLimited();
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> (res.status <span style="color:#ff7b72;font-weight:bold">===</span> <span style="color:#a5d6ff">408</span> <span style="color:#ff7b72;font-weight:bold">||</span> res.status <span style="color:#ff7b72;font-weight:bold">&gt;=</span> <span style="color:#a5d6ff">500</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">throw</span> <span style="color:#ff7b72">new</span> Error(<span style="color:#a5d6ff">`status </span><span style="color:#a5d6ff">${</span>response.status<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">`</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>res.ok) <span style="color:#ff7b72">throw</span> <span style="color:#ff7b72">new</span> BadRequest();
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">else</span> ok();
</span></span></code></pre></td></tr></table>
</div>
</div><p><br></br></p>
<p>If it is your request, do not teach your breaker to panic.
<br></br></p>
<hr>
<h2 id="pitfall-3-no-timeout-means-the-breaker-never-gets-a-clean-failure">Pitfall 3: no timeout means the breaker never gets a clean failure</h2>
<p>This one is sneaky.</p>
<p>If requests hang, they do not fail. They just… sit there… forever… like a haunted loading spinner.
<br></br>
Your breaker needs calls to <em>resolve</em> so it can observe success or failure.
So you almost always want a timeout in the same neighborhood as the breaker.
<br></br>
Timeouts are the &quot;this took too long, we are done here&quot; boundary.
Breakers are the &quot;this keeps happening, we are not doing it again for a bit&quot; boundary.
<br></br>
They work best as a pair.
<br></br></p>
<div class="highlight"><div style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Bad: hung requests never resolve, so you just stack more
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">async</span> <span style="color:#ff7b72">function</span> getData() {
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">const</span> response <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">await</span> fetch(url); <span style="color:#8b949e;font-style:italic">// could hang a long time
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>  <span style="color:#ff7b72">return</span> response.json();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">await</span> Promise.all(Array.from({ length<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">500</span> }, () =&gt; getData())); <span style="color:#8b949e;font-style:italic">// pile-up
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><br></br></p>
<hr>
<h2 id="pitfall-4-flappy-breakers">Pitfall 4: flappy breakers</h2>
<p>If your cooldown is too short, you get this loop:</p>
<ol>
<li>dependency is sick</li>
<li>breaker opens</li>
<li>cooldown ends</li>
<li>breaker goes half-open</li>
<li>dependency is still sick</li>
<li>breaker opens again</li>
<li>repeat until everyone is exhausted
<br></br></li>
</ol>
<p>The breaker is doing its job, but you still get noisy logs, noisy alerts, and your system is spending its time poking a wound.
<br></br></p>
<p>A good cooldown is long enough that the dependency has a chance to recover, and short enough that you are not stuck failing fast forever.
<br></br></p>
<p>There is no universal number, but &quot;10 seconds&quot; is usually not a magic spell. It is just a number people type because it looks reasonable.
<br></br></p>
<div class="highlight"><div style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Bad: opens fast, probes constantly, &#34;recovers&#34; instantly
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>createCircuitBreaker({
</span></span><span style="display:flex;"><span>  failureThreshold<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">1</span>,
</span></span><span style="display:flex;"><span>  successThreshold<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">1</span>,
</span></span><span style="display:flex;"><span>  cooldownMs<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">500</span>,
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></td></tr></table>
</div>
</div><p><br></br></p>
<hr>
<h2 id="pitfall-5-we-added-a-circuit-breaker-but-you-really-didnt">Pitfall 5: &quot;we added a circuit breaker&quot; <em>(but you really didn’t)</em></h2>
<p>This happens in serverless and horizontally scaled systems a lot.
<br></br></p>
<p>If every instance has its own breaker state, and traffic is spread across many instances, you can end up with:</p>
<ul>
<li>no single breaker seeing enough consecutive failures to trip</li>
<li>or half your instances tripped and half not, which is chaos with extra steps
<br></br></li>
</ul>
<p>The pattern still helps per instance, but you need to understand what you actually built:
a local safety mechanism, not a globally consistent guardian angel.
<br></br></p>
<p>If you want shared breaker state, that becomes a different design problem.
<br></br></p>
<div class="highlight"><div style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Bad: new circuit breaker per call, so it has no memory
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">async</span> <span style="color:#ff7b72">function</span> handler(request<span style="color:#ff7b72;font-weight:bold">:</span> Request) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">const</span> circuitBreaker <span style="color:#ff7b72;font-weight:bold">=</span> createCircuitBreaker({ failureThreshold<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">3</span>, cooldownMs<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">30_000</span> });
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">return</span> circuitBreaker.wrap(() =&gt; callDependency(request))();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><br></br></p>
<hr>
<h2 id="pitfall-6-no-fallback-plan">Pitfall 6: no fallback plan</h2>
<p>An open circuit is not a fix, it is a choice.
<br></br></p>
<p>If you open the circuit and then just throw a 500, all you did was make your failure faster (which is still sometimes good, to be fair).
<br></br></p>
<p>The real win is when you already know what to do during the open state:</p>
<ul>
<li>return cached data</li>
<li>return partial data</li>
<li>degrade the UI</li>
<li>queue work for later</li>
<li>serve a stale result with a warning
<br></br></li>
</ul>
<p>A circuit breaker without a fallback is like buying a fire extinguisher and storing it in a different building.
<br></br></p>
<div class="highlight"><div style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Bad: open circuit = fast failure, nothing else
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">return</span> <span style="color:#ff7b72">await</span> callProtected(); <span style="color:#8b949e;font-style:italic">// throws -&gt; user suffers
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Better: stale cache fallback
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">try</span> { <span style="color:#ff7b72">return</span> <span style="color:#ff7b72">await</span> callProtected(); }
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">catch</span> { <span style="color:#ff7b72">return</span> cache.get(<span style="color:#a5d6ff">&#34;key&#34;</span>) <span style="color:#ff7b72;font-weight:bold">??</span> renderFallback(); }
</span></span></code></pre></td></tr></table>
</div>
</div><p><br></br></p>
<hr>
<h2 id="solution">Solution</h2>
<p>Think of these as three separate knobs:
<br></br></p>
<ol>
<li><strong>Timeout</strong>: &quot;this single attempt has a max cost&quot;</li>
<li><strong>Retry</strong>: &quot;this failure might be transient&quot;</li>
<li><strong>Circuit breaker</strong>: &quot;this dependency might be unhealthy, stop hammering it&quot;
<br></br></li>
</ol>
<p>They stack nicely, but only if they agree on what counts as &quot;retryable&quot; vs &quot;breaker worthy&quot;.
<br></br></p>
<hr>
<h2 id="breakerkit">BreakerKit</h2>
<p>I wrote a library called <strong>BreakerKit</strong> mainly because I wanted these primitives to be small and composable:
<code>withTimeout</code>, <code>retry</code>, and <code>circuitBreaker</code>.</p>
<p><br></br></p>
<div class="highlight"><div style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#737679">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff7b72">import</span> {
</span></span><span style="display:flex;"><span>  circuitBreaker,
</span></span><span style="display:flex;"><span>  retry,
</span></span><span style="display:flex;"><span>  withTimeout,
</span></span><span style="display:flex;"><span>  CircuitOpenError,
</span></span><span style="display:flex;"><span>  TimeoutError,
</span></span><span style="display:flex;"><span>} <span style="color:#ff7b72">from</span> <span style="color:#a5d6ff">&#34;breakerkit&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Wrap the risky call with a breaker.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Put a timeout inside so hangs turn into real failures.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">const</span> resilientFetchJson <span style="color:#ff7b72;font-weight:bold">=</span> circuitBreaker(
</span></span><span style="display:flex;"><span>  (url: <span style="color:#ff7b72">string</span>) <span style="color:#ff7b72;font-weight:bold">=&gt;</span>
</span></span><span style="display:flex;"><span>    withTimeout(() <span style="color:#ff7b72;font-weight:bold">=&gt;</span> fetch(url).then((r) <span style="color:#ff7b72;font-weight:bold">=&gt;</span> r.json()), <span style="color:#a5d6ff">5</span>_000),
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    failureThreshold: <span style="color:#ff7b72">3</span>,
</span></span><span style="display:flex;"><span>    cooldownMs: <span style="color:#ff7b72">30_000</span>,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">export</span> <span style="color:#ff7b72">async</span> <span style="color:#ff7b72">function</span> getData(url: <span style="color:#ff7b72">string</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">return</span> retry(() <span style="color:#ff7b72;font-weight:bold">=&gt;</span> resilientFetchJson(url), {
</span></span><span style="display:flex;"><span>    retries: <span style="color:#ff7b72">3</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b949e;font-style:italic">// This matters: if the circuit is open, do not retry the refusal.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>    shouldRetry<span style="color:#ff7b72;font-weight:bold">:</span> (err) <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72;font-weight:bold">!</span>(err <span style="color:#ff7b72">instanceof</span> CircuitOpenError),
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">async</span> <span style="color:#ff7b72">function</span> demo() {
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">const</span> data <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">await</span> getData(<span style="color:#a5d6ff">&#34;https://api.example.com/data&#34;</span>);
</span></span><span style="display:flex;"><span>    console.log(data);
</span></span><span style="display:flex;"><span>  } <span style="color:#ff7b72">catch</span> (err) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">if</span> (err <span style="color:#ff7b72">instanceof</span> TimeoutError) {
</span></span><span style="display:flex;"><span>      console.log(<span style="color:#a5d6ff">&#34;Slow dependency. Timeouts are doing their job.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">if</span> (err <span style="color:#ff7b72">instanceof</span> CircuitOpenError) {
</span></span><span style="display:flex;"><span>      console.log(<span style="color:#a5d6ff">&#34;Dependency is unhealthy. Circuit is open. Use fallback here.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">throw</span> err;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><br></br>
BreakerKit’s breaker defaults and options are straightforward: <code>failureThreshold</code>, <code>successThreshold</code>, <code>cooldownMs</code>, plus an <code>onStateChange</code> callback so you can log/alert when it opens.</p>
<p>That last part is important. If you do not observe state transitions, you will ship a breaker and then forget it exists until it ruins your graphs.</p>
<p><br></br></p>
<hr>
<h2 id="final-thoughts">Final thoughts</h2>
<p>The circuit breaker pattern is simple, but the consequences aren’t.
<br></br></p>
<ul>
<li>It is not a &quot;reliability feature&quot; system addon.</li>
<li>It is a statement about how your system behaves under stress.</li>
<li>If you count the wrong failures, you trip when you shouldn’t.</li>
<li>If you skip timeouts, you never trip at all.</li>
<li>If you retry everything, you amplify outages.</li>
<li>If you add a breaker with no fallback, you just fail faster and call it architecture.
<br></br></li>
</ul>
<p>Still worth it. Just respect it a little.</p>
<p><br></br></p>
<hr>
<h2 id="links">Links</h2>
<p>BreakerKit repo: <a href="https://github.com/Cr0wn-Gh0ul/BreakerKit">https://github.com/Cr0wn-Gh0ul/BreakerKit</a><br>
BreakerKit on npm: <a href="https://www.npmjs.com/package/breakerkit">https://www.npmjs.com/package/breakerkit</a></p>

    </div>
    
    
    <nav class="post-navigation" style="display: flex; justify-content: space-between; gap: 2em; margin-top: 2em;">
        <div class="nav-prev">
            
            ← <a href="https://cr0wn-gh0ul.github.io/Cr0wn-Gh0ul/posts/2025-12-17/">My Career Journey ... So Far</a>
            
        </div>
        <div class="nav-next" style="margin-left:auto;">
            
        </div>
    </nav>
    
</article>

        </main>
        
    </div>
    <footer class="site-footer"
  style="flex-shrink:0;left:0;right:0;margin:0 auto;padding:0;display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono','SF Mono','Fira Code','Consolas',monospace;font-size:12px;color:#8a8a9c;height:44px;text-align:center;z-index:1000;width:100%;background:none;box-shadow:none;position:relative;">
  <a href="#" id="scrollTop"
    style="margin-left:16px;margin-right:auto;display:flex;align-items:center;justify-content:center;width:40px;height:40px;font-size:18px;color:#4ade5e;text-decoration:none;opacity:.6;transition:opacity 0.2s;cursor:pointer;flex-shrink:0;">↑</a>
  <p style="width:100%;text-align:center;margin:0;">© 2026 Cr0wn_Gh0ul</p>
  <script>
    
    document.addEventListener('DOMContentLoaded', function () {
      const scrollTop = document.getElementById('scrollTop');
      window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
          scrollTop.style.opacity = '1';
          scrollTop.style.pointerEvents = 'auto';
        } else {
          scrollTop.style.opacity = '0.6';
          scrollTop.style.pointerEvents = 'auto';
        }
      });
      scrollTop.addEventListener('click', (e) => {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });
  </script>
  
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.12.2/+esm'

function getMermaidConfigFromTheme() {
  const styles = getComputedStyle(document.documentElement);
  const cssVar = (name, fallback) => styles.getPropertyValue(name).trim() || fallback;

  const backgroundPrimary = cssVar("--bg-primary", "#1b1b1f");
  const backgroundSecondary = cssVar("--bg-secondary", "#09090a");

  const blue = cssVar("--blue", "#5cb8ff");
  const red = cssVar("--red", "#ff7070");
  const green = cssVar("--green", "#4ade5e");

  const fontMono = cssVar("--font-mono", "JetBrains Mono, SF Mono, Consolas, monospace");

  return {
    theme: "base",
    themeVariables: {
      darkMode: true,
      fontFamily: fontMono,
      fontSize: "14px",
      background: backgroundPrimary,

      primaryColor: blue,
      primaryTextColor: "#000",

      lineColor: red,
      textColor: green,
      edgeLabelBackground: backgroundSecondary,
      titleColor: green,
    },

    themeCSS: `
      /* Nodes (flowchart + generic) */
      .node rect, .node polygon, .node circle, .node path {
        fill: ${blue} !important;
        stroke: ${blue} !important;
        stroke-width: 2px !important;
      }
      .node text, .node tspan {
        fill: #000 !important;
      }

      /* State diagram nodes */
      .statediagram-state rect, .stateGroup rect {
        fill: ${blue} !important;
        stroke: ${blue} !important;
        stroke-width: 2px !important;
      }
      .statediagram-state text, .statediagram-state tspan,
      .stateGroup text, .stateGroup tspan {
        fill: #000 !important;
      }

      /* Arrows / edges */
      .edgePath path {
        stroke: ${red} !important;
        stroke-width: 1.75px !important;
      }
      marker path {
        stroke: ${red} !important;
        fill: ${red} !important;
      }

      /* Edge labels (arrow text) */
      .edgeLabel rect {
        fill: ${backgroundSecondary} !important;
        stroke: ${red} !important;
        stroke-width: 1px !important;
      }
      .edgeLabel text, .edgeLabel tspan,
      .label text, .label tspan {
        fill: ${green} !important;
      }
    `,
  };
}

    function renderAllMermaid() {
      const mermaidConfig = getMermaidConfigFromTheme();
      mermaid.initialize({
        startOnLoad: true,
        ...mermaidConfig,
      });
      mermaid.run({ querySelector: ".mermaid" });
      document.querySelectorAll('pre.mermaid, .mermaid').forEach(block => {
        mermaid.run({ nodes: [block] });
      });
    }
    renderAllMermaid();
    
    const observer = new MutationObserver(() => {
      renderAllMermaid();
    });
    observer.observe(document.body, { childList: true, subtree: true });
  </script>
  
</footer>
</body>
</html>

